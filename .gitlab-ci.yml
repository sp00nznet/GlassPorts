stages:
  - validate
  - build

variables:
  ANDROID_VERSION: "9"
  PARALLEL_JOBS: "4"
  GIT_SUBMODULE_STRATEGY: recursive

default:
  tags:
    - debian
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq curl wget git python3 make gcc g++ zip unzip default-jdk
    - mkdir -p $HOME/bin
    - export PATH="$HOME/bin:$PATH"
    - curl -s https://storage.googleapis.com/git-repo-downloads/repo > $HOME/bin/repo
    - chmod a+x $HOME/bin/repo
    - git config --global user.email "ci@buildforever.cloud"
    - git config --global user.name "GitLab CI"

validate:
  stage: validate
  before_script: []
  script:
    - echo "Validating build scripts..."
    - bash -n build-glassports.sh
    - bash -n build/envsetup.sh
    - echo "Checking required files..."
    - test -f build.config
    - test -d device
    - test -d kernel
    - test -d packages
    - test -d vendor
    - echo "Validation passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:
  stage: build
  script:
    - echo "Starting GlassPorts build for Android $ANDROID_VERSION"
    - chmod +x build-glassports.sh
    - |
      # Watchdog process - prints status every 60 seconds to prevent CI stuck detection
      (while true; do sleep 60; echo "[watchdog] $(date) - build active, disk: $(df -h / | tail -1 | awk '{print $3"/"$2}')"; done) &
      WATCHDOG_PID=$!
      ./build-glassports.sh --version $ANDROID_VERSION --jobs $PARALLEL_JOBS --skip-deps
      BUILD_STATUS=$?
      kill $WATCHDOG_PID 2>/dev/null || true
      exit $BUILD_STATUS
  artifacts:
    paths:
      - out/*.zip
      - out/*.img
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  timeout: 6h

build:manual:
  stage: build
  script:
    - echo "Starting full GlassPorts build for Android $ANDROID_VERSION"
    - chmod +x build-glassports.sh
    - |
      (while true; do sleep 60; echo "[watchdog] $(date) - build active"; done) &
      WATCHDOG_PID=$!
      ./build-glassports.sh --version $ANDROID_VERSION --jobs $PARALLEL_JOBS --clean
      BUILD_STATUS=$?
      kill $WATCHDOG_PID 2>/dev/null || true
      exit $BUILD_STATUS
  artifacts:
    paths:
      - out/*.zip
      - out/*.img
    expire_in: 1 week
  when: manual
  allow_failure: true
  timeout: 8h
